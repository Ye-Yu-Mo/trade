# Binance 测试网 URL 修复说明

## 🔧 问题发现

根据 [Binance 官方文档](https://developers.binance.com/docs/zh-CN/derivatives/usds-margined-futures/general-info)，发现代码中使用的 API 地址不正确：

**错误配置**：
- ❌ 代码使用：`https://fapi.binance.com`（主网地址）
- ✅ 应该使用：`https://testnet.binancefuture.com`（测试网地址）

## ✅ 已修复内容

### 1. 动态 URL 选择

修改了 `src/market.rs` 和 `src/executor.rs`，添加动态 URL 选择函数：

```rust
// 根据环境变量选择 Binance URL
fn get_binance_base_url() -> String {
    match env::var("BINANCE_TESTNET").as_deref() {
        Ok("true") => "https://testnet.binancefuture.com".to_string(),
        _ => "https://fapi.binance.com".to_string(),
    }
}
```

### 2. 环境变量控制

通过 `.env` 文件中的 `BINANCE_TESTNET=true` 控制使用测试网还是主网：

```bash
# 使用测试网（推荐）
BINANCE_TESTNET=true

# 使用主网（谨慎！）
BINANCE_TESTNET=false
```

### 3. 测试脚本更新

`test_config.sh` 现在会根据环境变量自动选择正确的 URL 进行测试：

```bash
if [ "$BINANCE_TESTNET" = "true" ]; then
    BINANCE_URL="https://testnet.binancefuture.com"
    echo "   使用测试网: $BINANCE_URL"
else
    BINANCE_URL="https://fapi.binance.com"
    echo "   使用主网: $BINANCE_URL"
fi
```

## ✅ 验证结果

运行 `./test_config.sh` 验证修复：

```
============================================================
  配置测试 - 验证 API 连接
============================================================

1. 测试 Binance 测试网连接...
   使用测试网: https://testnet.binancefuture.com
   ✓ Binance API 连接成功
   ✓ BTCUSDT 当前价格: $114,910.80

2. 测试 DeepSeek API 连接...
   ✓ DeepSeek API 连接成功
   ✓ API Key 有效

✓ 所有配置正确，可以运行程序
```

## 📝 Binance 测试网使用说明

### 获取测试网 API 密钥

1. 访问 https://demo.binance.com
2. 使用 GitHub 或 Google 账号登录
3. 进入 Futures 合约交易页面
4. 点击右上角头像 → **API Management**
5. 创建新的 API Key
6. 复制 API Key 和 Secret 到 `.env` 文件

### 测试网特性

✅ **优点**：
- 完全免费，自动提供虚拟 USDT
- 市场数据与主网实时同步
- 可以安全测试交易策略
- 支持所有主网交易对

⚠️ **限制**：
- 仅用于测试，不涉及真实资金
- 可能存在与主网的细微差异
- 部分高级功能可能受限

### API 端点对照

| 环境 | REST API | WebSocket |
|------|----------|-----------|
| 测试网 | `https://testnet.binancefuture.com` | `wss://fstream.binancefuture.com` |
| 主网 | `https://fapi.binance.com` | `wss://fstream.binance.com` |

## 🚀 下一步

修复已完成，系统现在正确使用测试网 API。你可以：

1. **验证配置**
   ```bash
   ./test_config.sh
   ```

2. **启动系统**
   ```bash
   ./run.sh
   ```

3. **观察运行**
   - 系统会连接到测试网
   - 使用虚拟资金进行交易
   - 不会影响真实资金

## ⚠️ 切换到主网（慎重）

如果经过充分测试后想使用主网，需要：

1. 修改 `.env` 文件：
   ```bash
   BINANCE_TESTNET=false
   BINANCE_API_KEY=你的主网API密钥
   BINANCE_SECRET=你的主网SECRET
   ```

2. **重要警告**：
   - ⚠️ 主网交易涉及真实资金
   - ⚠️ 建议至少在测试网运行1个月
   - ⚠️ 观察策略盈亏后再考虑主网
   - ⚠️ 使用极小的交易金额（如 0.001 BTC）

## 📊 修改文件列表

```
修改的文件：
├── src/market.rs       添加 get_binance_base_url() 函数
├── src/executor.rs     添加 get_binance_base_url() 函数
├── test_config.sh      动态选择测试网/主网 URL
├── README.md           更新测试网获取说明
└── 测试网修复说明.md   本文件
```

## ✅ 总结

- ✓ 修复了测试网 URL 错误
- ✓ 添加了环境变量控制
- ✓ 验证测试通过
- ✓ 更新了文档说明

现在可以安全地使用测试网进行交易测试了！
